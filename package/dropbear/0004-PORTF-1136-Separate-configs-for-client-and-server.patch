From 1ac3b617c4b1bfd49fd85a674cef999fddeabe2a Mon Sep 17 00:00:00 2001
From: Jonathan BEN-AVRAHAM <jonathan.ba@siklu.com>
Date: Fri, 19 Aug 2022 15:34:37 +0300
Subject: [PATCH] PORTF-1136 Separate configs for client and server

Allow separate configuration options for the dropbear client, "dbclient"
and the dropbear server "dropbear" in order to allow different cipher
sets or other common configs to be defined for each executable separately.

Separate configuration only makes sense when MULTI (single binary for
both client and server) is not defined.
---
 Makefile.in                    | 14 +++++++++++---
 common-algo.c => common-algo.h |  0
 options.h => common-options.h  |  0
 dbclient-algo.c                |  5 +++++
 dbmalloc.h                     |  2 +-
 dh_groups.c                    |  2 +-
 dh_groups.h                    |  2 +-
 dropbear-algo.c                |  5 +++++
 includes.h                     |  4 +++-
 9 files changed, 27 insertions(+), 7 deletions(-)
 rename common-algo.c => common-algo.h (100%)
 rename options.h => common-options.h (100%)
 create mode 100644 dbclient-algo.c
 create mode 100644 dropbear-algo.c

diff --git a/Makefile.in b/Makefile.in
index 182cb42..d8ee4ed 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -29,6 +29,14 @@ ifneq ($(wildcard localoptions.h),)
 CFLAGS+=-DLOCALOPTIONS_H_EXISTS
 OPTION_HEADERS += localoptions.h
 endif
+ifneq ($(wildcard dropbear-options.h),)
+CFLAGS+=-DDROPBEAR_OPTIONS_H_EXISTS
+OPTION_HEADERS += dropbear-options.h
+endif
+ifneq ($(wildcard dbclient-options.h),)
+CFLAGS+=-DDBCLIENT_OPTIONS_H_EXISTS
+OPTION_HEADERS += dbclient-options.h
+endif
 
 COMMONOBJS=dbutil.o buffer.o dbhelpers.o \
 		dss.o bignum.o \
@@ -43,14 +51,14 @@ COMMONOBJS=dbutil.o buffer.o dbhelpers.o \
 SVROBJS=svr-kex.o svr-auth.o sshpty.o \
 		svr-authpasswd.o svr-authpubkey.o svr-authpubkeyoptions.o svr-session.o svr-service.o \
 		svr-chansession.o svr-runopts.o svr-agentfwd.o svr-main.o svr-x11fwd.o\
-		svr-tcpfwd.o svr-authpam.o
+		svr-tcpfwd.o svr-authpam.o dropbear-algo.o
 
 CLIOBJS=cli-main.o cli-auth.o cli-authpasswd.o cli-kex.o \
 		cli-session.o cli-runopts.o cli-chansession.o \
 		cli-authpubkey.o cli-tcpfwd.o cli-channel.o cli-authinteract.o \
-		cli-agentfwd.o 
+		cli-agentfwd.o dbclient-algo.o
 
-CLISVROBJS=common-session.o packet.o common-algo.o common-kex.o \
+CLISVROBJS=common-session.o packet.o common-kex.o \
 			common-channel.o common-chansession.o termcodes.o loginrec.o \
 			tcp-accept.o listener.o process-packet.o dh_groups.o \
 			common-runopts.o circbuffer.o list.o netio.o chachapoly.o gcm.o
diff --git a/common-algo.c b/common-algo.h
similarity index 100%
rename from common-algo.c
rename to common-algo.h
diff --git a/options.h b/common-options.h
similarity index 100%
rename from options.h
rename to common-options.h
diff --git a/dbclient-algo.c b/dbclient-algo.c
new file mode 100644
index 0000000..5625163
--- /dev/null
+++ b/dbclient-algo.c
@@ -0,0 +1,5 @@
+#include "common-options.h"
+#ifdef DBCLIENT_OPTIONS_H_EXISTS
+#include "dbclient-options.h"
+#endif
+#include "common-algo.h"
diff --git a/dbmalloc.h b/dbmalloc.h
index d5e814e..47389f9 100644
--- a/dbmalloc.h
+++ b/dbmalloc.h
@@ -3,7 +3,7 @@
 
 #include "stdint.h"
 #include "stdlib.h"
-#include "options.h"
+#include "common-options.h"
 
 void * m_malloc(size_t size);
 void * m_calloc(size_t nmemb, size_t size);
diff --git a/dh_groups.c b/dh_groups.c
index 920f3f6..a7c91fe 100644
--- a/dh_groups.c
+++ b/dh_groups.c
@@ -1,4 +1,4 @@
-#include "options.h"
+#include "common-options.h"
 #include "dh_groups.h"
 
 #if DROPBEAR_NORMAL_DH
diff --git a/dh_groups.h b/dh_groups.h
index c995937..848329d 100644
--- a/dh_groups.h
+++ b/dh_groups.h
@@ -1,6 +1,6 @@
 #ifndef DROPBEAR_DH_GROUPS_H
 #define DROPBEAR_DH_GROUPS_H
-#include "options.h"
+#include "common-options.h"
 
 #if DROPBEAR_NORMAL_DH
 
diff --git a/dropbear-algo.c b/dropbear-algo.c
new file mode 100644
index 0000000..f90f4a7
--- /dev/null
+++ b/dropbear-algo.c
@@ -0,0 +1,5 @@
+#include "common-options.h"
+#ifdef DROPBEAR_OPTIONS_H_EXISTS
+#include "dropbear-options.h"
+#endif
+#include "common-algo.h"
diff --git a/includes.h b/includes.h
index 884ebf7..c84ef9b 100644
--- a/includes.h
+++ b/includes.h
@@ -28,7 +28,7 @@
 /* uclibc needs _GNU_SOURCE, maybe other things? */
 #define _GNU_SOURCE
 
-#include "options.h"
+#include "common-options.h"
 #include "debug.h"
 
 #include <sys/types.h>
@@ -60,6 +60,8 @@
 #include <time.h>
 #include <setjmp.h>
 
+#include "siklu_pwd.h"   // Siklu
+
 #ifdef HAVE_UTMP_H
 #include <utmp.h>
 #endif
-- 
2.17.1

